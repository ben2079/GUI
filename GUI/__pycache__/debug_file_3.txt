from datetime import datetime
import os
import sys
from ChatClassCompletion import ChatComEditor
from sys_Cmd import sys_Cmd

class Caller:
    def __init__(self):
        now = datetime.now()
        self.date = now.strftime('%d.%m.%Y')
        self.time = now.strftime('%H:%M:%S')
        self.dateTime = now
        self.unix_t = now.timestamp()
        self.s_ID = str(self.unix_t)
        self.vn = 0.0
        self.orpa = sys.argv[0]               # Originating path (script filename)
        self.fileTl = "debug&sreview.txt"
        self.path = os.path.dirname(self.orpa)

    def __repr__(self):
        return (f"Caller(date='{self.date}', time='{self.time}', "
                f"dateTime={self.dateTime}, unix_t={self.unix_t}, "
                f"vn={self.vn}, path='{self.path}', "
                f"SessionID='{self.s_ID}', Originpath='{self.orpa}')")

class CallerDebugger(Caller, ChatComEditor):
    def __init__(self):
        super().__init__()

    def read_write(self):
        filename = f"{self.path}_{self.fileTl}_{self.date}_{self.vn}_{self.s_ID}"
        w = None

        # Write initial debug session mark
        try:
            with open(filename, "a") as file:
                file.write("Debugg session python3\n")
        except Exception as e:
            print(f"Error writing file: {e}")

        # Run the file and capture output
        input_text = ""
        try:
            run = sys_Cmd()
            res = run.CmdSys(f"python3 {filename}")
            stdout = res.stdout.decode("utf-8")
            stderr = res.stderr.decode("utf-8")
            print(stdout, stderr)

            # Read back the file (if needed)
            try:
                with open(filename, "r") as file:
                    text = file.read()
            except Exception as e:
                print(f"Error reading file: {e}")
                text = ""
            input_text = text + stderr
        except Exception as e:
            print(f"Error running CmdSys: {e}")
            input_text = ""

        # Process with ChatComEditor
        try:
            editor = ChatComEditor(input_text)
            editor.get_readedit()
            w = editor(self.orpa, filename, input_text)  # If this is intended usage
        except Exception as e:
            print(f"Error (ChatComEditor read): {e}")

        print(f"input_text: {input_text} response: {w}")

        # Optional: writing edit result
        try:
            ChatComEditor().get_writeedit(w=w)
        except Exception as e:
            print(f"Error (ChatComEditor write): {e}")

if __name__ == "__main__":
    dbg = CallerDebugger()
    dbg.read_write()