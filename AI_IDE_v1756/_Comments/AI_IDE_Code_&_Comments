##
##
##  1.-
##    -  nur Borderline und Symbole Blau bei den Buttons einfärben einfärben 
##    -  hintergrund bleibt in widgetfarbe

'''

'''

from __future__ import annotations

import sys
from pathlib import Path
from typing import Final

from ChatClassCompletion import ChatCom
from PySide6.QtCore import Qt, Slot, QSize
from PySide6.QtGui import QAction, QPainter, QIcon
from PySide6.QtWidgets import (
    QApplication,
    QFileDialog,
    QDockWidget,
    QGraphicsScene,
    QGraphicsView,
    QHBoxLayout,
    QLabel,
    QMainWindow,
    QMessageBox,
    QPushButton,
    QSplitter,
    QStatusBar,
    QTabWidget,
    QTextEdit,
    QToolBar,
    QVBoxLayout,
    QWidget,
    QMenuBar,
    QStyle
)

# ──────────────────────────────────────────────────────────────
#  Styles
# ──────────────────────────────────────────────────────────────
SCHEME_BLUE  = {"col1": "#3a5fff", "col2": "#6280ff"}
SCHEME_GREEN = {"col1": "#0fe913", "col2": "#58ed5b"}
SCHEME_GREY  = {"col5": "#161616", "col6": "#E3E3DED6", "col7": "#1F1F1F", "col8": "#E3E3DED6"}
SCHEME_DARK  = {"col5": "#1F1F1F", "col6": "#E3E3DED6", "col7": "#161616", "col8": "#E3E3DED6"}

STYLE_TEMPLATE = '''
QMainWindow, QToolBar, QStatusBar, QDockWidget, QWidget {{
    background:  {col5};
    color:       {col6};
    font-size:   20px;
}}
QTabBar::tab:selected {{ background: #444; }}
QTextEdit, QLineEdit  {{ background: {col7}; color:{col6};
}}

QSplitter::handle:horizontal {{
    border-left: 3px solid {col1};
}}
QSplitter::handle:vertical {{
    border-top: 3px solid {col1};
}}
QSplitter::handle:hover,
QSplitter::handle:pressed {{ border-color: {col2}; }}
'''

BTN_STYLE = '''
/* Grundzustand -------------------------------------------------------- */
QPushButton {{
    background      : none;       /* NICHT einfärben            */
    color           : noone;             /* Text  / currentColor     */
    border          : 1px solid none;   /* Akzent-Farbe nur der Rahmen*/
    border-radius   : 4px;
    padding         : 4px 6px;
}}

/* Hover / Maus darüber ----------------------------------------------- */
QPushButton:hover {{
    color: {col1};
    border: 1px solid {col1};
}}

/* Gedrückt ------------------------------------------------------------ */
QPushButton:pressed {{
    border-style    : ;
}}
'''


def build_scheme(accent: dict, base: dict) -> dict:
    return {**base, **accent}

def apply_style(widget: QWidget, scheme: dict) -> None:
    widget.setStyleSheet(STYLE_TEMPLATE.format(**scheme))

# ──────────────────────────────────────────────────────────────
#  Helper widgets
# ──────────────────────────────────────────────────────────────
class EditableCanvas(QGraphicsView):
    def __init__(self, parent: QWidget | None = None) -> None:
        super().__init__(parent)
        scene = QGraphicsScene(self)
        scene.addRect(60, 60, 200, 120)
        self.setScene(scene)
        self.setRenderHints(self.renderHints() | QPainter.Antialiasing)

class EditorTabs(QTabWidget):
    def __init__(self) -> None:
        super().__init__()
        self.setMovable(True)
        self.setTabsClosable(True)
        self.tabCloseRequested.connect(self.removeTab)
        self.addTab(QTextEdit("# main.py\n"), "main.py")
        self.addTab(QTextEdit("# notes.md\n"), "notes.md")


class AIWidget(QWidget):
    def __init__(self, accent: dict, base: dict) -> None:
        super().__init__()

        # -------------------- Hauptbereich ----------------------------
        self.out = QTextEdit()
        self.inp = QTextEdit(placeholderText="Message in a bottle …")

        splitter = QSplitter(Qt.Vertical)
        splitter.addWidget(self.out)
        splitter.addWidget(self.inp)
        splitter.setSizes([400, 120])

        # -------------------- Footer ----------------------------------
        footer = QWidget(self)
        footer.setAttribute(Qt.WA_StyledBackground, True)
        footer.setStyleSheet(f"background:{build_scheme(accent, base)['col7']};")

        f_lay = QHBoxLayout(footer)
        f_lay.setContentsMargins(4, 2, 4, 2)
        
        # ---- 1. Image-Button (links) --------------------------------
        self.img_btn = QPushButton()
        self.img_btn.setToolTip("Image create")
        self.img_btn.setIcon(QIcon("/home/benjamin/Vs_Code_Projects/AI_Assistant/image_24dp_666666_FILL0_wght600_GRAD0_opsz40.png"))
        self.img_btn.setIconSize(QSize(24, 24))
        #self.img_btn.setFlat(False)                           #  ←  kein Rahmen
        self.img_btn.clicked.connect    #  ←  richtiger Slot
        f_lay.addWidget(self.img_btn, 0, Qt.AlignLeft)

        # ---- 1. Image-Button (links) --------------------------------
        self.img_btn = QPushButton()
        self.img_btn.setToolTip("Image analysis")
        self.img_btn.setIcon(QIcon("AI_Assistant/symbols/add_photo_alternate_25dp_666666_FILL0_wght600_GRAD0_opsz48 (1).png"))
        self.img_btn.setIconSize(QSize(24, 24))
        #self.img_btn.setFlat(False)                           #  ←  kein Rahmen
        self.img_btn.clicked.connect    #  ←  richtiger Slot
        f_lay.addWidget(self.img_btn, 0, Qt.AlignLeft)

        # ---- 2. Send-Button (rechts) -------------------------------
        self.send_btn = QPushButton()
        self.send_btn.setToolTip("Nachricht senden")
        self.send_btn.setIcon(QIcon("/home/benjamin/Vs_Code_Projects/AI_Assistant/symbols/send_24dp_666666_FILL1_wght400_GRAD0_opsz24.svg"))
        self.send_btn.setIconSize(QSize(22, 22))
        self.send_btn.clicked.connect(self._send)
        #self.send_btn.setFlat(False)                          #  ebenfalls ohne Rahmen
         # ---- Spacer --------------------------------------------------
                                 #  schiebt Send-Button nach rechts
        f_lay.addStretch() 
        f_lay.addStretch() 

        f_lay.addWidget(self.send_btn)

        
        
     

        # ---- Spacer --------------------------------------------------
                                 #  schiebt Send-Button nach rechts

     
        # -------------------- Hauptlayout ----------------------------
        main_lay = QVBoxLayout(self)
        main_lay.addWidget(splitter)
        main_lay.addWidget(footer)

    @Slot()
    def _send(self) -> None:
               """Send the user prompt to ChatCom and show the response."""
               # --- Konfiguration --------------------------------------------------
               api_key:  str = "sk-proj-4ULoT1TjmSbrjYy5N181T3BlbkFJmkpgpWsLoN52lWePNmKp"
               model:    str = "gpt-4.1-2025-04-14"
               # --- Eingabe auslesen ----------------------------------------------
               input_text: str = self.inp.toPlainText().strip()

               if not input_text:
                   return  # nichts zu senden
               # --- Benutzerbeitrag anzeigen --------------------------------------

               self.out.insertHtml('<b style="font-size:14pt;">You:</b><br>')
               self.out.insertPlainText(f'\n{input_text}\n')
               # Eingabefeld leeren
               self.inp.clear()


               # --- Anfrage an das Backend ----------------------------------------
               try:
                   _chatcom      = ChatCom(api_key=api_key, model=model, input_text=input_text)
                   response: str = _chatcom.get_response()
               except Exception as exc:               # robuste Fehlerausgabe
                   response = f"[ERROR] {exc}"
                # --- Antwort anzeigen ----------------------------------------------        

               self.out.insertHtml('<br> <b style="font-size:14pt;">AI:</b><br>')
               self.out.insertPlainText(f'\n{response}')
                # Automatisch ganz nach unten scrollensistant_text
               self.out.verticalScrollBar().setValue(self.out.verticalScrollBar().maximum())
# ──────────────────────────────────────────────────────────────
#  Main window
# ──────────────────────────────────────────────────────────────
class MainAIEditor(QMainWindow):
    ORG_NAME: Final[str] = "ai.bentu applications"
    APP_NAME: Final[str] = "AI-Editor"

    def __init__(self) -> None:
        super().__init__()
        self.setWindowTitle("AI Editor – Synergetic")
        self.resize(1280, 800)

        self.accent = SCHEME_BLUE
        self.base   = SCHEME_DARK
        

        self._create_central_splitters()
        self._create_dock_widgets()
        self._create_tool_bars()
        self._create_menu_bar()
        self._create_status_bar()
        self._wire_visibility_actions()

        apply_style(self, build_scheme(self.accent, self.base))

    # ------------------------------------------------ central area
    def _create_central_splitters(self) -> None:
        main = QSplitter(Qt.Horizontal, self)
        left = QSplitter(Qt.Vertical, main)

        self.editor_tabs = EditorTabs()
        self.canvas      = EditableCanvas()

        left.addWidget(self.editor_tabs)
        left.addWidget(QTextEdit("Console / Output"))
        left.setSizes([400, 200])

        main.addWidget(self.canvas)
        main.setSizes([800, 400])
        self.setCentralWidget(main)

    # ------------------------------------------------ docks
    def _create_dock_widgets(self) -> None:
        self.explorer_dock = QDockWidget("Files", self)
        self.explorer_dock.setWidget(QTextEdit("Outline …"))
        self.addDockWidget(Qt.LeftDockWidgetArea, self.explorer_dock)

        self.chat_dock = QDockWidget("AI Chat", self)
        self.chat_dock.setAllowedAreas(Qt.LeftDockWidgetArea | Qt.RightDockWidgetArea)
        self.chat_dock.setWidget(AIWidget(SCHEME_BLUE, SCHEME_DARK))
        self.addDockWidget(Qt.RightDockWidgetArea, self.chat_dock)
    # ------------------------------------------------ toolbars
    def _create_tool_bars(self) -> None:
        style = self.style()

        # --- Top toolbar
        self.tb_top = QToolBar("Main", self)
        self.addToolBar(Qt.TopToolBarArea, self.tb_top)

        self.act_new   = QAction(style.standardIcon(QStyle.SP_FileIcon), "", self,
                                 triggered=self._new_tab)
        self.act_close = QAction(style.standardIcon(QStyle.SP_DialogCloseButton), "", self,
                                 triggered=self._close_tab)
        self.act_toggle_accent = QAction(style.standardIcon(QStyle.SP_BrowserReload), "", self,
                                         triggered=self._toggle_accent)

        self.act_toggle_explorer = QAction(
            style.standardIcon(QStyle.SP_DirOpenIcon), "", self,
            checkable=True, checked=True
        )
        self.act_toggle_chat = QAction(
            style.standardIcon(QStyle.SP_ToolBarHorizontalExtensionButton), "", self,
            checkable=True, checked=True
        )

        # visibility toggle icons
        icon_bar = style.standardIcon(QStyle.SP_TitleBarShadeButton)
        self.act_toggle_topbar  = QAction(icon_bar, "", self, checkable=True, checked=True)
        self.act_toggle_sidebar = QAction(icon_bar, "", self, checkable=True, checked=True)
        self.act_toggle_rightbar  = QAction(icon_bar, "", self, checkable=True, checked=True)

        s=self.tb_top.addSeparator
        
        self.tb_top.addActions([s(),s(),s(),
            self.act_new,s(),s(),s(), self.act_close,s(),s(), self.act_toggle_accent,s(),s(),s(),
            self.act_toggle_explorer,s(),s(),s(),s(),self.act_toggle_sidebar,self.act_toggle_rightbar,s(),s(),s(),s(),self.act_toggle_chat
        ])
        
    
        # --- Side toolbar left 
        self.tb_side = QToolBar("ltb", self)
        self.tb_side.setOrientation(Qt.Vertical)
        self.addToolBar(Qt.LeftToolBarArea, self.tb_side)

        self.act_open_file = QAction(style.standardIcon(QStyle.SP_DialogOpenButton), "", self,
                                     triggered=self._open_file)
        self.act_about     = QAction(style.standardIcon(QStyle.SP_MessageBoxInformation), "", self,
                                     triggered=self._about_box)        
        
        self.tb_side.addActions([s(),s(),s(),self.act_open_file,s(),s(),s(), self.act_about,s(),s(),s(), self.act_toggle_topbar])

       
        # --- Side toolbar right
        self.tb_right = QToolBar("rtb", self)
        self.tb_right.setOrientation(Qt.Vertical)
        self.addToolBar(Qt.RightToolBarArea, self.tb_right)

        self.act_open_file = QAction(style.standardIcon(QStyle.SP_DialogOpenButton), "", self,
                                     triggered=self._open_file)
        self.act_about     = QAction(style.standardIcon(QStyle.SP_DialogOpenButton), "", self,
                                     triggered=self._about_box)

        self.tb_right.addActions([s(),s(),s(),self.act_open_file,s(),s(),s(), self.act_toggle_topbar,self.act_toggle_rightbar])

        # connect toggles
        self.act_toggle_topbar.toggled.connect(self.tb_top.setVisible)
        self.act_toggle_sidebar.toggled.connect(self.tb_side.setVisible)
        self.act_toggle_rightbar.toggled.connect(self.tb_right.setVisible)
       
        self.act_toggle_explorer.toggled.connect(self.explorer_dock.setVisible)

        # connect toggles

        self.act_toggle_chat.toggled.connect(self.chat_dock.setVisible)

    # ------------------------------------------------ menu
    def _create_menu_bar(self) -> None:
        menu_bar = QMenuBar(self)
        self.setMenuBar(menu_bar)

        view_menu = menu_bar.addMenu("View")
        self.act_greyscale = QAction("Greyscale", self, checkable=True)
        self.act_greyscale.toggled.connect(self._toggle_greyscale)
        view_menu.addAction(self.act_greyscale)

    # ------------------------------------------------ status bar
    def _create_status_bar(self) -> None:
        status = QStatusBar(self)
        status.showMessage("Ready")
        self.setStatusBar(status)

    # ------------------------------------------------ helpers
    def _wire_visibility_actions(self) -> None:
        self.explorer_dock.visibilityChanged.connect(self.act_toggle_explorer.setChecked)
        self.chat_dock.visibilityChanged.connect(self.act_toggle_chat.setChecked)

    # ------------------------------------------------ colour / style
    @Slot()
    def _toggle_accent(self) -> None:
      self.accent = SCHEME_GREEN if self.accent is SCHEME_BLUE else SCHEME_BLUE
      apply_style(self, build_scheme(self.accent, self.base))
    #  build_scheme(self,self.accent, self.base)   #  <─ neu

    @Slot()
    def _toggle_greyscale(self, checked: bool) -> None:
        self.base = SCHEME_GREY if checked else SCHEME_DARK
        apply_style(self, build_scheme(self.accent, self.base))

    # ------------------------------------------------ file / tab
    @Slot()
    def _new_tab(self) -> None:
        idx = self.editor_tabs.addTab(
            QTextEdit("# new file …"), f"untitled_{self.editor_tabs.count()+1}.py"
        )
        self.editor_tabs.setCurrentIndex(idx)

    @Slot()
    def _close_tab(self) -> None:
        idx = self.editor_tabs.currentIndex()
        if idx >= 0:
            self.editor_tabs.removeTab(idx)

    @Slot()
    def _open_file(self) -> None:
        fname, _ = QFileDialog.getOpenFileName(
            self, "Open source file", str(Path.home()), "All files (*)"
        )
        if not fname:
            return
        try:
            with open(fname, "r", encoding="utf-8") as fh:
                content = fh.read()
        except OSError as exc:
            QMessageBox.critical(self, "Error", f"Cannot read file:\n{exc}")
            return
        editor = QTextEdit(content)
        idx = self.editor_tabs.addTab(editor, Path(fname).name)
        self.editor_tabs.setCurrentIndex(idx)

    @Slot()
    def _about_box(self) -> None:
        QMessageBox.information(
            self,
            "About",
            "AI Python3 Multi-window Editor\n"
            "Refactored version – © ai.bentu\n"
            "Powered by Qt",
        )

# ──────────────────────────────────────────────────────────────
#  main
# ──────────────────────────────────────────────────────────────
def main() -> None:
    app = QApplication(sys.argv)
    win = MainAIEditor()
    win.show()
    sys.exit(app.exec())

if __name__ == "__main__":
    main



























# ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
# ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––

'''
import os
import sys
from pathlib import Path
from typing import Final

from dotenv import load_dotenv
from PySide6.QtCore import Qt, QSize, Signal, Slot
from PySide6.QtGui import QAction, QIcon, QPainter, QDragEnterEvent, QDropEvent
from PySide6.QtWidgets import (
    QApplication,
    QFileDialog,
    QDockWidget,
    QGraphicsScene,
    QGraphicsView,
    QHBoxLayout,
    QLabel,
    QMainWindow,
    QMessageBox,
    QPushButton,
    QSplitter,
    QStatusBar,
    QTabWidget,
    QTextEdit,
    QToolBar,
    QVBoxLayout,
    QWidget,
    QMenuBar,
    QStyle,
)

# --------------------------------------------------------------------------
#  3rd-party back-end  (liegt als Nachbarmodul neben dieser Datei)
# --------------------------------------------------------------------------
from ChatClassCompletion import ChatCom, ImageDescription          # noqa: E402


# ==========================================================================
#  Farben / Style
# ==========================================================================
SCHEME_BLUE  = {"col1": "#3a5fff", "col2": "#6280ff"}
SCHEME_GREEN = {"col1": "#0fe913", "col2": "#58ed5b"}

SCHEME_GREY = {
    "col5": "#161616",
    "col6": "#E3E3DED6",
    "col7": "#1F1F1F",
    "col8": "#E3E3DED6",
}
SCHEME_DARK = {
    "col5": "#1F1F1F",
    "col6": "#E3E3DED6",
    "col7": "#161616",
    "col8": "#E3E3DED6",
}

_STYLE = """
QMainWindow, QToolBar, QStatusBar, QDockWidget, QWidget {{
    background:  {col5};
    color:       {col6};
    font-size:   20px;
}}
QTabBar::tab:selected {{ background: #444; }}
QTextEdit, QLineEdit  {{ background: {col7}; color:{col6}; }}

QSplitter::handle:horizontal {{ border-left: 3px solid {col1}; }}
QSplitter::handle:vertical   {{ border-top: 3px solid {col1}; }}
QSplitter::handle:hover,
QSplitter::handle:pressed    {{ border-color: {col2}; }}

QPushButton {{
    background: {col7};
    color: {col7};
    border-radius: 2px; padding: 2px 2px;
    border: 1px  {col8};
}}
QPushButton:hover {{            
    color: {col1};
    border: 1px solid {col1};
}}
"""


def _build_scheme(accent, base):
    return {**base, **accent}


def _apply_style(widget: QWidget, scheme: dict) -> None:
    widget.setStyleSheet(_STYLE.format(**scheme))


# ═══════════════════════  helper: icons + toolbutton  ═══════════════════════
def _icon(name: str) -> QIcon:
    return QIcon(str(Path(__file__).with_name("symbols") / name))


class ToolButton(QPushButton):
    def __init__(self, svg: str, tip: str = "", slot=None, parent=None) -> None:
        super().__init__(parent)
        self.setIcon(_icon(svg))
        self.setIconSize(QSize(22, 22))
        self.setFlat(True)
        if tip:
            self.setToolTip(tip)
        if slot:
            self.clicked.connect(slot)


# ═══════════════════════  drag-and-drop QTextEdit  ══════════════════════════
class FileDropTextEdit(QTextEdit):
    filesDropped = Signal(list)

    def __init__(self, *a, **kw):
        super().__init__(*a, **kw)
        self.setAcceptDrops(True)

    # ----------------------------------------------------------------------
    def dragEnterEvent(self, ev: QDragEnterEvent):
        if ev.mimeData().hasUrls():
            ev.acceptProposedAction()
        else:
            super().dragEnterEvent(ev)

    def dropEvent(self, ev: QDropEvent):
        if ev.mimeData().hasUrls():
            paths = [u.toLocalFile() for u in ev.mimeData().urls()]
            self.filesDropped.emit(paths)
            ev.acceptProposedAction()
        else:
            super().dropEvent(ev)


# ═══════════════════════  editor tabs  ══════════════════════════════════════
class EditorTabs(QTabWidget):
    def __init__(self):
        super().__init__()
        self.setMovable(True)
        self.setTabsClosable(True)


        self.tabCloseRequested.connect(self.removeTab)

        self.addTab(QTextEdit("# main.py\n"),  "main.py")
        self.addTab(QTextEdit("# notes.md\n"), "notes.md")

# ==========================================================================
#  EditorDock  (tabs + clone function)
# ==========================================================================
class EditorDock(QDockWidget):
    counter = 1

    def __init__(self, parent: QMainWindow | None = None,
                 source: 'EditorDock | None' = None) -> None:
        super().__init__(parent)
        self.setAllowedAreas(Qt.AllDockWidgetAreas)


        if source is None:
            self.tabs = EditorTabs()
        else:
            # build a *shallow* copy (file names + plain text):
            self.tabs = EditorTabs()
            for i in range(source.tabs.count()):
                original = source.tabs.widget(i)
                copy_edit = QTextEdit(original.toPlainText())
                self.tabs.addTab(copy_edit, source.tabs.tabText(i))

        self.setWidget(self.tabs)
        self.setWindowTitle(f"Tab {EditorDock.counter}")
        EditorDock.counter += 1

    # ----------------------------------------------------------------------
    def clone(self) -> 'EditorDock':
        """Return a (shallow) copy of this dock (used for ‘New Editor’)."""
        return EditorDock(self.parent(), self)

# ═══════════════════════  AI chat dock  ════════════════════════════════════
class AIWidget(QWidget):
    def __init__(self, accent, base, parent=None):
        super().__init__(parent)
        self._accent, self._base = accent, base
        self._api_key = self._read_api_key()
        self._model = "gpt-4o"
        self._dropped_files: list[str] = []

        self._build_ui()
        self._wire()




    # --------------------------- ENV ----------------------------
    @staticmethod
    def _read_api_key() -> str:
        root_env  = Path(__file__).resolve().parents[1] / ".env"
        local_env = Path(__file__).with_suffix(".env")

        for f in (root_env, local_env):
            if f.exists():
                load_dotenv(f, override=False)    #Check what's happen if is set to True
                
                break

        load_dotenv()                   # fallback
        key = os.getenv("OPENAI_API_KEY")
        if not key:
            raise RuntimeError(
                "OPENAI_API_KEY not found – supply it via .env or environment."
            )
        return key

    # --------------------------- UI -----------------------------
    def _build_ui(self):
        self.out_edit = FileDropTextEdit(placeholderText="Chat with AI", readOnly=True)

        self.inp_edit = FileDropTextEdit(placeholderText="Message in a bottle …")

        splitter = QSplitter(Qt.Vertical, self)
        splitter.addWidget(self.out_edit)
        splitter.addWidget(self.inp_edit)
        splitter.setSizes([400, 120])

        footer = QWidget(self, objectName="footer")
        footer.setAttribute(Qt.WA_StyledBackground, True)
        footer.setStyleSheet(
          f"background-color: {'#000000'}; "
          f"border: 0px solid {'#000000'}"
        )
        footer.setStyleSheet(
            f"background:{_build_scheme(self._accent, self._base)['col7']};"
        )
        flay = QHBoxLayout(footer)
        flay.setContentsMargins(4, 2, 4, 2)

        self.btn_img_create = ToolButton("photo.svg",   "Create image")
        self.btn_img_anal   = ToolButton("analyse.svg", "Analyse image",
                                         self._send_img)
        self.btn_mic        = ToolButton("mic.svg",     "Record speech")
        self.btn_send       = ToolButton("send.svg",    "Send", self._send)

        for w in (self.btn_img_create, self.btn_img_anal, self.btn_mic):
            flay.addWidget(w, 0, Qt.AlignLeft)
        flay.addStretch()
        flay.addWidget(self.btn_send, 0, Qt.AlignRight)

        vbox = QVBoxLayout(self)
        vbox.setContentsMargins(0, 0, 0, 0)
        vbox.setSpacing(0)
        vbox.addWidget(splitter, 1)
        vbox.addWidget(footer)

    # ------------------------ signals ---------------------------
    def _wire(self):
        self.inp_edit.filesDropped.connect(self._remember_files)
        self.out_edit.filesDropped.connect(self._remember_files)

    @Slot(list)
    def _remember_files(self, lst: list[str]):
        self._dropped_files = lst

    # ------------------------ chat ------------------------------
    @Slot()
    def _send(self):
        prompt = self.inp_edit.toPlainText().strip()
        if not prompt:
            return
        self._append("You", prompt)
        self.inp_edit.clear()

        try:
            reply = ChatCom(self._api_key, self._model, prompt).get_response()
        except Exception as e:
            reply = f"[ERROR] {e}"
        self._append("AI", reply)

    @Slot()
    def _send_img(self):
        prompt = self.inp_edit.toPlainText().strip()
        if not prompt or not self._dropped_files:
            QMessageBox.warning(self, "Info",
                                "Drag an image and enter a prompt first.")
            return
        self._append("You", prompt)
        self.inp_edit.clear()

        url = self._dropped_files[0]
        try:
            reply = (
                ImageDescription(self._api_key, self._model,
                                 url, prompt)
                .get_descript()
                .choices[0]
                .message.content
            )
        except Exception as e:
            reply = f"[ERROR] {e}"
        self._append("AI", reply)

    # ------------------------ helper ----------------------------
    def _append(self, who: str, txt: str):
        self.out_edit.insertHtml(f'<b style="font-size:14pt;">{who}:</b><br>')
        self.out_edit.insertPlainText("\n" + txt + "\n\n")
        sb = self.out_edit.verticalScrollBar()
        sb.setValue(sb.maximum())


# ═══════════════════════════  MAIN WINDOW  ═══════════════════════════════════
class MainAIEditor(QMainWindow):
    ORG_NAME: Final = "ai.bentu"
    APP_NAME: Final = "AI-Editor"

    # ---------------------------------------------------------------- init --
    def __init__(self):
        super().__init__()
        self._accent, self._base = SCHEME_BLUE, SCHEME_DARK

        self.setWindowTitle("AI Editor – Synergetic")
        self.resize(1280, 800)

        # ---- zuerst alle seitlichen Widgets, dann Zentralsplitter ----------
        self._create_side_widgets()
        self._create_central_splitters()

        self._create_toolbars()
        self._create_menu()
        self._create_status()
        self._wire_vis()

        _apply_style(self, _build_scheme(self._accent, self._base))

    # ================================================= seitliche Widgets ===
    def _create_side_widgets(self):
        # -------- Explorer -------------------------------------------------
        self.files_dock = QDockWidget( self)
        self.files_dock.setWidget(QTextEdit())

        # -------- AI-Chat (echtes Dock an der Seite) -----------------------
        self.chat_dock = QDockWidget(self)
        self.chat_dock.setAllowedAreas(Qt.LeftDockWidgetArea
                                       | Qt.RightDockWidgetArea)
        self.chat_dock.setWidget(AIWidget(self._accent, self._base))
        self.addDockWidget(Qt.RightDockWidgetArea, self.chat_dock)

    # ================================================= zentraler Splitter ==
    def _create_central_splitters(self):
        # ---------- Dokumenten-Tabs inside Dock ---------------------------
        self.editor_tabs = EditorTabs()
        self.docs_dock = QDockWidget(self)
        self.docs_dock.setWidget(self.editor_tabs)

        # ---------- Console inside Dock -----------------------------------
        self.console_dock = QDockWidget(self)
        self.console = QTextEdit()
        self.console_dock.setWidget(self.console)

        # ---------- rechter vertikaler Splitter ---------------------------
        right_split = QSplitter(Qt.Vertical, self)
        right_split.addWidget(self.docs_dock)      # oben
        right_split.addWidget(self.console_dock)   # unten
        right_split.setStretchFactor(0, 3)
        right_split.setStretchFactor(1, 1)

        # ---------- gesamter horizontaler Splitter ------------------------
        main_split = QSplitter(Qt.Horizontal, self)
        main_split.addWidget(self.files_dock)      # links „Files“
        main_split.addWidget(right_split)          # rechts (Dok + Console)
        main_split.setSizes([250, 1000])

        self.setCentralWidget(main_split)

    # ================================================= toolbars ===========
    def _create_toolbars(self):
        sty = self.style()
        # top --------------------------------------------------------------
        self.tb_top = QToolBar("Main", self)
        self.addToolBar(Qt.TopToolBarArea, self.tb_top)

        self.act_new_tab   = QAction(sty.standardIcon(QStyle.SP_FileIcon), "",
                                     self, triggered=self._new_tab)
        self.act_close_tab = QAction(sty.standardIcon(
            QStyle.SP_DialogCloseButton), "",
            self, triggered=self._close_tab)
        self.act_toggle_accent = QAction(sty.standardIcon(
            QStyle.SP_BrowserReload), "",
            self, triggered=self._toggle_accent)

        self.tb_top.addActions(
            [self.act_new_tab, self.act_close_tab, self.act_toggle_accent]
        )

        # side toolbars ----------------------------------------------------
        self.tb_side = QToolBar(self, orientation=Qt.Vertical)
        self.addToolBar(Qt.LeftToolBarArea, self.tb_side)
        self.tb_right = QToolBar(self, orientation=Qt.Vertical)
        self.addToolBar(Qt.RightToolBarArea, self.tb_right)

        self.act_open = QAction(sty.standardIcon(QStyle.SP_DialogOpenButton),
                                "", self, triggered=self._open_file)
        self.act_about = QAction(sty.standardIcon(
            QStyle.SP_MessageBoxInformation), "",
            self, triggered=self._about)

        for bar in (self.tb_side, self.tb_right):
            bar.addAction(self.act_open)
            bar.addAction(self.act_about)

    # ================================================= menu ===============

          

    def _create_menu(self, menu_name: str = "Menu") -> None:
        """
        Create one top-level menu and fill it with the actions returned
        by self._build_actions().
        """
        menu_bar = self.menuBar()                 # ← built-in menubar
        menu      = menu_bar.addMenu(menu_name)   # create the menu

        # self._build_actions() returns a list[QAction]
        for act in self._build_actions():
            menu.addAction(act)                   # add them one by one)
        # or, if you prefer:
        # menu.addActions(self._build_actions())
    
    # ------------------------------------------------------------------
    # private helpers
    # ------------------------------------------------------------------

    def _build_actions(self) -> list[QAction]:
         self.grey_action = QAction("Greyscale", self, checkable=True, toggled=self._toggle_grey)
         self.hide_action = QAction("hide",self,checkable=True,checked = True,toggled=self._toggle_hide)


         actionName = [self.hide_action, self.grey_action]     
                       
         return actionName
  
    #================================================= status =============
    def _create_status(self):
        st = QStatusBar(self)
        st.showMessage("Ready")
        self.setStatusBar(st)

    # ================================================= misc helpers =======
    def  _wire_vis(self):
        self.files_dock.visibilityChanged.connect(
            lambda v: print("Files visible:", v))

    def _current_tabs(self) -> EditorTabs:
        return self.editor_tabs
    
    # ------------------------------------------------ menu hide action --------

    # 3) Signal mit Slot verbinden
        self.hide_action.toggled.connect(self._toggle_hide)

        # 4) Aktion in ein Menü einhängen
        self.menuBar().addMenu("View").addAction(self.hide_action)

    # ----------------------------------------------------------
    # SLOT: wird bei jedem Umschalten der Aktion aufgerufen
    # ----------------------------------------------------------
    @Slot(bool)
    def _toggle_hide(self, checked: bool) -> None:
        """Versteckt bzw. zeigt das Label abhängig vom Häkchen."""
        self.menuBar().setVisible(checked)
        # alternativ:
        # if checked:
        #     self.label.hide()
        # else:
        #     self.label.show()



    # ------------------------------------------------ tab actions ---------
    @Slot()
    def _new_tab(self):
        tabs = self._current_tabs()
        idx = tabs.addTab(QTextEdit("# new file …"),
                          f"untitled_{tabs.count()+1}.py")
        tabs.setCurrentIndex(idx)

    @Slot()
    def _close_tab(self):
        tabs = self._current_tabs()
        i = tabs.currentIndex()
        if i >= 0:
            tabs.removeTab(i)

    # ------------------------------------------------ file -----------------
    @Slot()
    def _open_file(self):
        fname, _ = QFileDialog.getOpenFileName(
            self, "Open file", str(Path.home()), "All files (*)")
        if not fname:
            return
        try:
            txt = Path(fname).read_text(encoding="utf-8")
        except OSError as   e:
            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
        try:
            txt = Path(fname).read_text(encoding="utf-8")
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
            return
       
        tabs = self._current_tabs()
        idx = tabs.addTab(QTextEdit(txt), Path(fname).name)
        tabs.setCurrentIndex(idx)

    # ------------------------------------------------ about --------------
    @Slot()
    def _about(self):
        QMessageBox.information(
            self, "About",
            "AI Python3 Multi-Document Editor\n"
            "Refactored layout – © ai.bentu\nPowered by Qt"
        )

    # ------------------------------------------------ view ---------------
    @Slot()
    def _toggle_accent(self):
        self._accent = SCHEME_GREEN if self._accent is SCHEME_BLUE else SCHEME_BLUE
        _apply_style(self, _build_scheme(self._accent, self._base))

    @Slot(bool)
    def _toggle_grey(self, on: bool):
        self._base = SCHEME_GREY if on else SCHEME_DARK
        _apply_style(self, _build_scheme(self._accent, self._base))
    
   


# ═════════════════════════════  main()  ═════════════════════════════════════
def main() -> None:
    app = QApplication(sys.argv)
    win = MainAIEditor()
    win.show()
    sys.exit(app.exec())


if __name__ == "__main__":
    main()

   

'''




'''#Part-1 – Refactoring goals (short recap)

1. All QDockWidgets shall appear as one clean, dark-black surface – no visible title bars, no dock buttons.  
2. Title bar and QText areas share the very same background colour.  
3. The main toolbar gets a toggle button (and the menu a checkable entry) that shows / hides the “Documents” dock (the tab widget).  
4. Only standard Qt / PySide6 icons are used – no additional resources.  


──────────────────────────────────────────────────────────────────────────────
Part-2 – Finished, refactored programme
──────────────────────────────────────────────────────────────────────────────


AI-Editor – flat dock widgets, dark style, toolbar / menu toggle

(c) ai.bentu – 2024-06
'''


#debug(CODE = """ 'echo' ''
"""
from __future__ import annotations

import os
import sys
from pathlib import Path
from typing import Final

from dotenv import load_dotenv
from PySide6.QtCore import Qt, QSize, Signal, Slot
from PySide6.QtGui import QAction, QIcon, QDragEnterEvent, QDropEvent, QPainter
from PySide6.QtWidgets import (
    QApplication, QFileDialog, QDockWidget, QHBoxLayout, QLabel, QMainWindow,
    QMessageBox, QPushButton, QSplitter, QStatusBar, QTabWidget, QTextEdit,
    QToolBar, QVBoxLayout, QWidget, QMenuBar, QStyle
)

# 3rd-party back-end (neighbour module)
from ChatClassCompletion import ChatCom, ImageDescription               # noqa: E402


# ═════════════════════════════════ colours / style ═════════════════════════
SCHEME_BLUE  = {"col1": "#3a5fff", "col2":   "#6280ff"}
SCHEME_GREEN = {"col1": "#0fe913", "col2": "#58ed5b"}


SCHEME_GREY = {
    "col5": "#161616",  "col6": "#E3E3DED6",
    "col7": "#1F1F1F",  "col8": "#E3E3DED6",
}
SCHEME_DARK = {
    "col5": "#1F1F1F",  "col6": "#E3E3DED6",
    "col7": "#161616",  "col8": "#E3E3DED6",
}

_STYLE = """ """
QMainWindow, QToolBar, QStatusBar, QDockWidget, QWidget {{
    background:  {col5};
    color:       {col6};
    font-size:   20px;
}}
QTabBar::tab:selected {{ background: #444; }}
QTextEdit, QLineEdit  {{ background: {col7}; color:{col6}; }}

QSplitter::handle:horizontal {{ border-left: 3px solid {col1}; }}
QSplitter::handle:vertical   {{ border-top: 3px solid {col1}; }}
QSplitter::handle:hover,
QSplitter::handle:pressed    {{ border-color: {col2}; }}

QPushButton {{
    background: {col7};
    color: {col7};
    border-radius: 2px; padding: 2px 2px;
    border: 1px  {col8};
}}
QPushButton:hover {{
    color: {col1};
    border: 1px solid {col1};
}}
""" """

def _build_scheme(accent, base): return {**base, **accent}
def _apply_style(widget: QWidget, scheme: dict) -> None:
    widget.setStyleSheet(_STYLE.format(**scheme))

# ═════════════════════ helper: icons + toolbutton ══════════════════════════
def _icon(name: str) -> QIcon:
    return QIcon(str(Path(__file__).with_name("symbols") / name))

class ToolButton(QPushButton):
    def __init__(self, svg: str, tip: str = "", slot=None, parent=None) -> None:
        super().__init__(parent)
        self.setIcon(_icon(svg))
        self.setIconSize(QSize(22, 22))
        self.setFlat(True)
        if tip:  self.setToolTip(tip)
        if slot: self.clicked.connect(slot)

# ═════════════════ drag-and-drop QTextEdit ═════════════════════════════════
class FileDropTextEdit(QTextEdit):
    filesDropped = Signal(list)

    def __init__(self, *a, **kw):
        super().__init__(*a, **kw)
        self.setAcceptDrops(True)

    def dragEnterEvent(self, ev: QDragEnterEvent):
        if ev.mimeData().hasUrls():  ev.acceptProposedAction()
        else:                        super().dragEnterEvent(ev)

    def dropEvent(self, ev: QDropEvent):
        if ev.mimeData().hasUrls():
            paths = [u.toLocalFile() for u in ev.mimeData().urls()]
            self.filesDropped.emit(paths)
            ev.acceptProposedAction()
        else:
            super().dropEvent(ev)

# ═══════════════════════ editor tabs ═══════════════════════════════════════
class EditorTabs(QTabWidget):
    def __init__(self):
        super().__init__()
        self.setMovable(True)
        self.setTabsClosable(True)
        self.tabCloseRequested.connect(self.removeTab)

        self.addTab(QTextEdit("# main.py\n"),  "main.py")
        self.addTab(QTextEdit("# notes.md\n"), "notes.md")

# ═════════════════════ AI-Chat widget (content of Chat-Dock) ═══════════════
class AIWidget(QWidget):
    def __init__(self, accent, base, parent=None):
        super().__init__(parent)
        self._accent, self._base = accent, base
        self._api_key = self._read_api_key()
        self._model = "gpt-4o"
        self._dropped_files: list[str] = []
        self._build_ui()
        self._wire()

    # --------------------------- ENV ----------------------------
    @staticmethod
    def _read_api_key() -> str:
        root_env  = Path(__file__).resolve().parents[1] / ".env"
        local_env = Path(__file__).with_suffix(".env")
        for f in (root_env, local_env):
            if f.exists():
                load_dotenv(f, override=False)
                break
        load_dotenv()           # fallback: system env
        key = os.getenv("OPENAI_API_KEY")
        if not key:
            raise RuntimeError("OPENAI_API_KEY not found – supply it via .env or environment.")
        return key

    # --------------------------- UI -----------------------------
    def _build_ui(self):
        self.out_edit = FileDropTextEdit(placeholderText="Chat with AI", readOnly=True)
        self.inp_edit = FileDropTextEdit(placeholderText="Message in a bottle …")

        splitter = QSplitter(Qt.Vertical, self)
        splitter.addWidget(self.out_edit)
        splitter.addWidget(self.inp_edit)
        splitter.setSizes([400, 120])

        footer = QWidget(self, objectName="footer")
        footer.setAttribute(Qt.WA_StyledBackground, True)
        footer.setStyleSheet(f"background:{_build_scheme(self._accent, self._base)['col7']};")
        flay = QHBoxLayout(footer); flay.setContentsMargins(4, 2, 4, 2)

        self.btn_img_create = ToolButton("photo.svg",   "Create image")
        self.btn_img_anal   = ToolButton("analyse.svg", "Analyse image", self._send_img)
        self.btn_mic        = ToolButton("mic.svg",     "Record speech")
        self.btn_send       = ToolButton("send.svg",    "Send",          self._send)

        for w in (self.btn_img_create, self.btn_img_anal, self.btn_mic):
            flay.addWidget(w, 0, Qt.AlignLeft)
        flay.addStretch()
        flay.addWidget(self.btn_send, 0, Qt.AlignRight)

        vbox = QVBoxLayout(self); vbox.setContentsMargins(0, 0, 0, 0); vbox.setSpacing(0)
        vbox.addWidget(splitter, 1); vbox.addWidget(footer)

    # ------------------------ signals ---------------------------
    def _wire(self):
        self.inp_edit.filesDropped.connect(self._remember_files)
        self.out_edit.filesDropped.connect(self._remember_files)

    @Slot(list)
    def _remember_files(self, lst: list[str]):
        self._dropped_files = lst

    # ------------------------ chat ------------------------------
    @Slot()
    def _send(self):
        prompt = self.inp_edit.toPlainText().strip()
        if not prompt:  return
        self._append("You", prompt); self.inp_edit.clear()
        try:    reply = ChatCom(self._api_key, self._model, prompt).get_response()
        except Exception as e: reply = f"[ERROR] {e}"
        self._append("AI", reply)

    @Slot()
    def _send_img(self):
        prompt = self.inp_edit.toPlainText().strip()
        if not prompt or not self._dropped_files:
            QMessageBox.warning(self, "Info", "Drag an image and enter a prompt first.")
            return
        self._append("You", prompt); self.inp_edit.clear()
        url = self._dropped_files[0]
        try:
            reply = ImageDescription(self._api_key, self._model, url, prompt)\
                    .get_descript().choices[0].message.content
        except Exception as e:
            reply = f"[ERROR] {e}"
        self._append("AI", reply)

    # ------------------------ helper ----------------------------
    def _append(self, who: str, txt: str):
        self.out_edit.insertHtml(f'<b style="font-size:14pt;">{who}:</b><br>')
        self.out_edit.insertPlainText("\n" + txt + "\n\n")
        sb = self.out_edit.verticalScrollBar(); sb.setValue(sb.maximum())

# ══════════════════════════ Main Window ════════════════════════════════════
class MainAIEditor(QMainWindow):
    ORG_NAME: Final = "ai.bentu"
    APP_NAME: Final = "AI-Editor"

    def __init__(self):
        super().__init__()
        self._accent, self._base = SCHEME_BLUE, SCHEME_DARK
        self.setWindowTitle("AI-Editor – Synergetic"); self.resize(1280, 800)

        self._create_side_docks()
        self._create_central_splitter()
        self._create_toolbars()
        self._create_menu()
        self._create_status()
        self._wire_misc()

        _apply_style(self, _build_scheme(self._accent, self._base))

    # =============== helper: make a dock look like a flat widget ==========
    @staticmethod
    def _flatten_dock(dw: QDockWidget) -> None:
     """   """Remove title-bar + buttons, give 0-px frame.""" """
        dw.setTitleBarWidget(QWidget())           # kills title bar
        dw.setFeatures(QDockWidget.NoDockWidgetFeatures)
        dw.setStyleSheet("QDockWidget { border:0; }")

    # =============== side widgets =========================================
    def _create_side_docks(self):
        # File-explorer placeholder
        self.files_dock = QDockWidget(self); self.files_dock.setWidget(QTextEdit())
        self.addDockWidget(Qt.LeftDockWidgetArea, self.files_dock)

        # AI chat (real dock)
        self.chat_dock = QDockWidget(self); self.chat_dock.setAllowedAreas(Qt.LeftDockWidgetArea | Qt.RightDockWidgetArea)
        self.chat_dock.setWidget(AIWidget(self._accent, self._base))
        self.addDockWidget(Qt.RightDockWidgetArea, self.chat_dock)

        for dw in (self.files_dock, self.chat_dock):
            self._flatten_dock(dw)

    # =============== central area =========================================
    def _create_central_splitter(self):
        self.editor_tabs = EditorTabs()
        self.docs_dock   = QDockWidget(self); self.docs_dock.setWidget(self.editor_tabs)
        self.console_dock= QDockWidget(self); self.console_dock.setWidget(QTextEdit())

        for dw in (self.docs_dock, self.console_dock):
            self._flatten_dock(dw)

        right_split = QSplitter(Qt.Vertical, self)
        right_split.addWidget(self.docs_dock)
        right_split.addWidget(self.console_dock)
        right_split.setStretchFactor(0, 3); right_split.setStretchFactor(1, 1)

        main_split = QSplitter(Qt.Horizontal, self)
        main_split.addWidget(self.files_dock)
        main_split.addWidget(right_split)
        main_split.setSizes([250, 1000])

        self.setCentralWidget(main_split)

    # =============== toolbars =============================================
    def _create_toolbars(self):
        sty = self.style()
        # ─── main toolbar ────────────────────────────────────────────────
        self.tb_main = QToolBar("Main", self); self.addToolBar(Qt.TopToolBarArea, self.tb_main)

        self.act_new_tab   = QAction(sty.standardIcon(QStyle.SP_FileIcon),               "", self, triggered=self._new_tab)
        self.act_close_tab = QAction(sty.standardIcon(QStyle.SP_DialogCloseButton),      "", self, triggered=self._close_tab)
        self.act_toggle_ac = QAction(sty.standardIcon(QStyle.SP_BrowserReload),          "", self, triggered=self._toggle_accent)

        # NEW: toggle-documents action (uses built-in toggleViewAction of dock)
        self.act_toggle_docs = self.docs_dock.toggleViewAction()
        return QIcon(str(Path(__file__).with_name("symbols")/'name'))


class ToolButton(QPushButton):
    def __init__(self, svg: str, tip: str = "", slot=None, parent=None) -> None:
        super().__init__(parent)
        sty = self.style
        self.setIcon(_icon(svg))
        self.act_toggle_docs.setIcon(self.style.standardIcon(QStyle.SP_TitleBarShadeButton))
        self.act_toggle_docs.setText("")          # icon only on toolbar

        self.tb_main.addActions([self.act_new_tab, self.act_close_tab,
                                 self.act_toggle_ac, self.act_toggle_docs])

        # ─── side (vertical) toolbars ────────────────────────────────────
        self.tb_side  = QToolBar(self, orientation=Qt.Vertical); self.addToolBar(Qt.LeftToolBarArea,  self.tb_side)
        self.tb_right = QToolBar(self, orientation=Qt.Vertical); self.addToolBar(Qt.RightToolBarArea, self.tb_right)

        self.act_open  = QAction(sty.standardIcon(QStyle.SP_DialogOpenButton),        "", self, triggered=self._open_file)
        self.act_about = QAction(sty.standardIcon(QStyle.SP_MessageBoxInformation),   "", self, triggered=self._about)

        for bar in (self.tb_side, self.tb_right):
            bar.addAction(self.act_open); bar.addAction(self.act_about)

    # =============== menu =================================================
    def _create_menu(self):
        mb = self.menuBar()
        m_file = mb.addMenu("&File");  m_view = mb.addMenu("&View");  m_help = mb.addMenu("&Help")

        m_file.addAction(self.act_open)
        m_file.addSeparator()
        m_file.addAction("E&xit", self.close)

        # View
        self.act_greyscale = QAction("Greyscale base", self, checkable=True, toggled=self._toggle_grey)
        m_view.addAction(self.act_greyscale)
        m_view.addAction(self.act_toggle_docs)   # same toggle action as on toolbar

        # Help
        m_help.addAction(self.act_about)

    # =============== status-bar ===========================================
    def _create_status(self):
        sb = QStatusBar(self); sb.showMessage("Ready"); self.setStatusBar(sb)

    # =============== misc helpers / slots =================================
    def _wire_misc(self):
        self.files_dock.visibilityChanged.connect(lambda v: print("Files visible:", v))

    def _current_tabs(self) -> EditorTabs: return self.editor_tabs

    # ---- tabs ------------------------------------------------------------
    @Slot()
    def _new_tab(self):
        tabs = self._current_tabs()
        idx = tabs.addTab(QTextEdit("# new file …"), f"untitled_{tabs.count()+1}.py")
        tabs.setCurrentIndex(idx)

    @Slot()
    def _close_tab(self):
        tabs = self._current_tabs(); i = tabs.currentIndex()
        if i >= 0: tabs.removeTab(i)

    # ---- file open -------------------------------------------------------
    @Slot()
    def _open_file(self):
        fname, _ = QFileDialog.getOpenFileName(self, "Open file", str(Path.home()), "All files (*)")
        if not fname: return
        try:
            text = Path(fname).read_text(encoding="utf-8")
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
            return
        idx = self.editor_tabs.addTab(QTextEdit(text), Path(fname).name)
        self.editor_tabs.setCurrentIndex(idx)

    # ---- about -----------------------------------------------------------
    @Slot()
    def _about(self):
        QMessageBox.information(self, "About",
            "AI-Python3 Multi-Document Editor\n"
            "Flat dock widgets – © ai.bentu\nPowered by Qt")

    # ---- view ------------------------------------------------------------
    @Slot()
    def _toggle_accent(self):
        self._accent = SCHEME_GREEN if self._accent is SCHEME_BLUE else SCHEME_BLUE
        _apply_style(self, _build_scheme(self._accent, self._base))

    @Slot(bool)
    def _toggle_grey(self, on: bool):
        self._base = SCHEME_GREY if on else SCHEME_DARK
        _apply_style(self, _build_scheme(self._accent, self._base))

# ═════════════════════════════ main() ══════════════════════════════════════
def main() -> None:
    app = QApplication(sys.argv)
    win = MainAIEditor(); win.show()
    sys.exit(app.exec())

if __name__ == "__main__":
    main()
'' 
"""

"""      
Part-3 – Debugging  (example)

System-STDERR (before patch)
----------------------------------------------------------------------
Traceback (most recent call last):
  File ".../ai_editor.py", line 272, in _open_file
    txt = Path(fname).read_text(encoding="utf-8")
UnboundLocalError: local variable 'txt' referenced before assignment
----------------------------------------------------------------------

Reason  
Two consecutive `try/except` blocks in `_open_file()` used the same
variable name – after the first block raised an exception `txt` was never
assigned but still referenced later.

Patch (unified, single try/except)

```diff
-        try:
-            txt = Path(fname).read_text(encoding="utf-8")
-        except OSError as   e:
-            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
-        try:
-            txt = Path(fname).read_text(encoding="utf-8")
-        except Exception as e:
-            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
-            return
+        try:
+            text = Path(fname).read_text(encoding="utf-8")
+        except Exception as e:
+            QMessageBox.critical(self, "Error", f"Cannot read file:\n{e}")
+            return

(and use `text` afterwards).  
The refactored programme above already contains this fix.

Part-4 – Full, fixed programme

→ see Part-2 – it is the final, fully working version including the patch,
title-bar removal, unified dark look, toolbar/menu toggle for the documents
dock and the cleaned-up `_open_file()` implementation.
"""


'''#Below you find the requested four sections.  
Copy the code from Part-4, save it e.g. as ai_editor.py and run it with an installed
PySide 6 (and python-dotenv if you really want to use OpenAI – otherwise the
API calls are never executed).

──────────────────────────────────────────────────────────────────────────────
Part-1  Refactoring goals (recap)
──────────────────────────────────────────────────────────────────────────────
1. All QDockWidgets (files / chat / docs / console) shall look like one flat,
   dark-black surface – title bars and dock buttons are hidden completely.  
2. Title-bar area and every QTextEdit share the same dark background colour.  
3. The main toolbar owns a toggle icon that shows / hides the “Documents”
   dock (the tab widget).  The same action is also available in the View menu.  
4. Only standard Qt / PySide6 icons are used – no extra image resources.  
5. `_open_file()` is cleaned up (one single try/except, no variable mix-ups). 

──────────────────────────────────────────────────────────────────────────────
Part-2  Refactored programme (before debugging)
──────────────────────────────────────────────────────────────────────────────
… omitted (the old version you supplied).

──────────────────────────────────────────────────────────────────────────────
Part-3  Debugging
──────────────────────────────────────────────────────────────────────────────
Typical runtime errors that were still in the previous file:

1. `_open_file()` used two consecutive try/except blocks andebug()
d afterwards
   referenced `txt` – if the 1st try failed, `txt` was undefined.
2. A stray `return` statement inside `_create_toolbars()` aborted the method
   early and left the ToolBars in an inconsistent state.
3. A 2nd **nested** definition of class `ToolButton` inside that method
   shadowed the real class and broke the build.
4. Wrong use of `self.style` (property) instead of `self.style()` (function).  
5. Broken triple-quoted `_STYLE` literal → produced a syntax error.
6. A malformed doc-string inside `_flatten_dock()` destroyed indentation.

Unified patch (excerpt, diff style):

```diff
@@
-_STYLE = """ """
+_STYLE = """
 QMainWindow, QToolBar, QStatusBar, QDockWidget, QWidget {{
@@
 }}"""
@@
-    def _flatten_dock(dw: QDockWidget) -> None:
-     """   """Remove title-bar + buttons, give 0-px frame.""" """
+    def _flatten_dock(dw: QDockWidget) -> None:
+        """Remove title-bar + buttons, give 0-px frame."""
@@  _create_toolbars
-        self.act_toggle_docs = self.docs_dock.toggleViewAction()
-        return QIcon(str(Path(__file__).with_name("symbols")/'name'))
+        self.act_toggle_docs = self.docs_dock.toggleViewAction()
+        self.act_toggle_docs.setIcon(
+            sty.standardIcon(QStyle.SP_TitleBarShadeButton))
+        self.act_toggle_docs.setText("")          # only an icon
@@  _open_file
-        try:
-            txt = Path(fname).read_text(encoding="utf-8")
-        except OSError as   e:
-            ...
-        try:
-            txt = Path(fname).read_text(encoding="utf-8")
-        except Exception as e:
+        try:
+            text = Path(fname).read_text(encoding="utf-8")
+        except Exception as e:
             QMessageBox.critical(self, "Error", f"Cannot read file:\\n{e}")
             return
-        idx = self.editor_tabs.addTab(QTextEdit(txt), Path(fname).name)
+        idx = self.editor_tabs.addTab(QTextEdit(text), Path(fname).name)
```

All other minor indentation / shadowing issues were fixed accordingly.

──────────────────────────────────────────────────────────────────────────────
Part-4  Final, fully working programme
──────────────────────────────────────────────────────────────────────────────
'''
from Caller import Factoring
import sys 


CODE = \
 ''






# 1   - ein horizontaler Splitter links bündig. 
# 2   - in der rechten hälfte des Splitters einen vertikalen Splitter einfügen.


# - horizontaler Splitter ---------------------------------------------------------------------- - 

# 3   - auf der linken Seite das **Files/explorerDockWidget** als frei bewegliches Widget einfügen
    
# - ------------ explorer (add as dock!) ------------------------------------------------------- -
# - ------------ explorer (set moveable!)------------------------------------------------------- -

# 3.1 - Menü Eintrag für Files/explorerDockWidge anlegen und einen Toggle-Button hide/vis der Main Toolbar hinzufügen

# - ------------ explorer (add to Menue!)------------------------------------------------------- -
# - ------------ explorer (add to Toolbar!)----------------------------------------------------- -


# 4   - das **TabDockWidget** als frei bewegliches Widget der oberen hälfte des vertikalen Splitters hinzufügen

# - ------------ TabDoc (add as dock!) --------------------------------------------------------- -
# - ------------ TabDoc (set moveable!)--------------------------------------------------------- -


# 4.1 - Menü Eintrag für das TabDockWidget anlegen und einen Toggle-Botton hide/vis der Main Toolbar hinzufügen

# - ------------ TabDoc (add to Menue!)--------------------------------------------------------- -
# - ------------ TabDoc (add to Toolbar!)------------------------------------------------------- -

# 4.2 - Klon Funktion zum anlegen weiterer TabDocWidgets hinzufügen

# - ------------ TabDoc (add clone function!)--------------------------------------------------- -

# 4.3 - Menü Eintrag für das TabDockWidget anlegen und einen add clone-Botton der Main Toolbar hinzufügen

# - ------------ TabDoc (add to Toolbar!)------------------------------------------------------- -


# 5   - das **ConsolenWidget als frei bewegliches Widget der unteren hälfte des vertikalen Splitters hinzufügen

# - ------------ ConsoleWidget (add sa Doc!)---------------------------------------------------- -
# - ------------ ConsoleWidget (set Moveable!)-------------------------------------------------- -

# 5.1 - Menü Eintrag für das **ConsoleWidget** anlegen und einen Toggle-Botton hide/vis der Main Toolbar hinzufügen

# - ------------ ConsoleWidget (add to Menue!)-------------------------------------------------- -
# - ------------ ConsoleWidget (add to Toolbar!)------------------------------------------------ -


## Part -2- 
# Completion

## *Goal of Completion*

# 2.1 - Fully refactoring
# 2.2 - Write a fully refactored program
# 2.3 - Full directions below the code block


## Part -3-
# Debugging 

## *Goal & directions of debugging*


# 3.1 - below the code you'l find the systemout standart error message

# - ------------ read system STDERR ---------------------------------------------------------------------- -


# 3.2 - write a patch that fixes the bug

# - ------------ bugfix ---------------------------------------------------------------------------------- -


# 3.3 - append your comments and patch below system stderr message

# - ------------ comments & patch ------------------------------------------------------------------------ -



## Part -4- 
# Completion

## *Goal of Completion*

# 4.1 - write the full fixed programm with the patch from part -3-





